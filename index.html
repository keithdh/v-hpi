<!DOCTYPE html>
<html>
    <head>
        <title>Chernoff faces</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <script type="text/javascript" src="../d3.min.js"></script>
        <script type="text/javascript" src="../d3.geo.min.js"></script>
        <script type="text/javascript" src="chernoff.js"></script>
        <script type="text/javascript" src="../jquery-1.6.2.min.js"></script>
        <style type="text/css">
.chernoff:hover > * {
    stroke-width: 2;
    stroke: #f00;
}

path {
    stroke: #000;
}
path.overlay {
    stroke: none;
    fill: #000;
    fill-opacity: 0;
}
path.overlay:hover {
    stroke-width: 2;
    stroke: #f00;
}

.active > * {
    stroke-width: 2;
    stroke: #f00;
}
path.active {
    stroke-width: 2;
    stroke: #f00;
}
        </style>
    </head>

    <body>
        <div id="map"></div>
        <div id="text"></div>
        <script type="text/javascript">
        (function () {
        var proj = d3.geo.equirectangular().scale(1).translate([0,0]),
            path = d3.geo.path().projection(proj),
            margin = 25,
            width = window.innerWidth - margin,
            height = window.innerHeight - margin,
            svg = d3.select("#map")
                .append("svg:svg")
                .attr("height", height)
                .attr("width", width),
            map = svg.append("svg:g")
                .attr("transform", "translate(0," + 100 + ")")
                .append("svg:g"),
            rb = svg.append("svg:g");

        d3.json("hpi.geojson", function(json) {
            var bounds0 = d3.geo.bounds(json),
                bounds = bounds0.map(proj),
                xscale = (width-100)/Math.abs(bounds[1][0] - bounds[0][0]),
                yscale = (height-100)/Math.abs(bounds[1][1] - bounds[0][1]),
                scale = Math.min(xscale, yscale);

            if(xscale > yscale) {
                var d = xscale * Math.abs(bounds[1][0] - bounds[0][0]) -
                    yscale * Math.abs(bounds[1][0] - bounds[0][0]);
                map.attr("transform", "translate(" + d/2 + ", 0)");
            } else {
                var d = yscale * Math.abs(bounds[1][1] - bounds[0][1]) -
                    xscale * Math.abs(bounds[1][1] - bounds[0][1]);
                map.attr("transform", "translate(0, " + d/2 + ")");
            }

            proj.scale(scale);
            proj.translate(proj([-bounds0[0][0], -bounds0[1][1]]));

            var hpiex = d3.extent($.map(json.features, function(f) {
                    return f.p.hpi;
                })),
                hpicscale = d3.scale.linear().domain(hpiex)
                    .range(["#fff", "#000"]),
                hpiscale = d3.scale.linear().domain(hpiex).range([-1, 1]),
                hlyex = d3.extent($.map(json.features, function(f) {
                    return f.p.hly;
                })),
                hlyscale = d3.scale.linear().domain(hlyex).range([-1, 1]),
                hdiex = d3.extent($.map(json.features, function(f) {
                    return f.p.hdi;
                })),
                hdiscale = d3.scale.linear().domain(hdiex).range([-1, 1]),
                gdpex = d3.extent($.map(json.features, function(f) {
                    return f.p.gdppc;
                })),
                gdpscale = d3.scale.linear().domain(gdpex).range([0, 1]),
                fWithData = $.grep(json.features, function(f) {
                    return f.p.hpi != undefined;
                });
                c = d3.chernoff()
                    .face(function(d) { return gdpscale(d.p.gdppc); })
                    .hair(function(d) { return hdiscale(d.p.hdi); })
                    .mouth(function(d) { return hpiscale(d.p.hpi); })
                    .brow(function(d) { return hlyscale(d.p.hly); });

            map.selectAll("path")
                .data(json.features)
                .enter().append("svg:path")
                .attr("d", path)
                .attr("fill", function(d) { return hpicscale(d.p.hpi); });

            map.selectAll("path.overlay")
                .data(fWithData)
                .enter().append("svg:path")
                .attr("class", "overlay")
                .attr("d", path)
                .on("mouseover", function(f) {
                    rb.selectAll("g.chernoff").data([f], function(e) {
                            return e.p.name;
                        }).classed("active", true);
                })
                .on("mouseout", function(f) {
                    rb.selectAll("g.chernoff").data([f], function(e) {
                            return e.p.name;
                        }).classed("active", false);
                });

            rb.selectAll("g.chernoff").data(fWithData).enter()
                .append("svg:g")
                .attr("class", "chernoff")
                .attr("transform", function(d, i) {
                    return "translate(" + i*50 + ",0)scale(.5)";
                })
                .attr("fill", function(d) { return hpicscale(d.p.hpi); })
                .on("mouseover", function(f) {
                    map.selectAll("path.overlay").data([f], function(e) {
                            return e.p.name;
                        }).classed("active", true);
                })
                .on("mouseout", function(f) {
                    map.selectAll("path.overlay").data([f], function(e) {
                            return e.p.name;
                        }).classed("active", false);
                })
                .call(c);
        });
        })();
        </script>
    </body>
</html>
